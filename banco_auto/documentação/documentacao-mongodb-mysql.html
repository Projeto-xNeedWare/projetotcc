<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentaÃ§Ã£o MongoDB â†’ MySQL</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h2 {
            color: #1e40af;
            margin-top: 30px;
            border-left: 4px solid #2563eb;
            padding-left: 10px;
        }
        h3 {
            color: #1e3a8a;
            margin-top: 25px;
        }
        pre {
            background-color: #f1f5f9;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #cbd5e1;
        }
        code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            background-color: #f1f5f9;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .info-box {
            background-color: #dbeafe;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .warning-box {
            background-color: #fef3c7;
            border-left: 4px solid #d97706;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success-box {
            background-color: #dcfce7;
            border-left: 4px solid #16a34a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .toc {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 15px;
        }
        .toc li {
            margin-bottom: 8px;
        }
        .toc a {
            text-decoration: none;
            color: #2563eb;
        }
        .toc a:hover {
            text-decoration: underline;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.5em;
            border-bottom: none;
        }
        .header p {
            font-size: 1.2em;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“š DOCUMENTAÃ‡ÃƒO COMPLETA</h1>
        <p>SISTEMA DE MIGRAÃ‡ÃƒO MONGODB â†’ MYSQL</p>
    </div>

    <div class="toc">
        <h2>ğŸ“‹ ÃNDICE</h2>
        <ul>
            <li><a href="#visao-geral">1. VisÃ£o Geral</a></li>
            <li><a href="#arquitetura">2. Arquitetura do Sistema</a></li>
            <li><a href="#pre-requisitos">3. PrÃ©-requisitos</a></li>
            <li><a href="#instalacao">4. InstalaÃ§Ã£o e ConfiguraÃ§Ã£o</a></li>
            <li><a href="#estrutura">5. Estrutura do Projeto</a></li>
            <li><a href="#implementacao">6. ImplementaÃ§Ã£o Completa</a></li>
            <li><a href="#execucao">7. Como Executar</a></li>
            <li><a href="#monitoramento">8. Monitoramento e Logs</a></li>
            <li><a href="#troubleshooting">9. Troubleshooting</a></li>
            <li><a href="#extensoes">10. ExtensÃµes e Melhorias</a></li>
        </ul>
    </div>

    <hr>

    <section id="visao-geral">
        <h1>ğŸ¯ VISÃƒO GERAL</h1>

        <h3>Objetivo</h3>
        <p>Criar um sistema automatizado em Python para migrar dados do MongoDB (NoSQL) para MySQL (SQL), mantendo integridade, rastreabilidade e possibilidade de rollback.</p>

        <h3>BenefÃ­cios</h3>
        <ul>
            <li>âœ… <strong>AutomaÃ§Ã£o completa</strong> da migraÃ§Ã£o</li>
            <li>âœ… <strong>ValidaÃ§Ã£o e limpeza</strong> de dados</li>
            <li>âœ… <strong>Backup automÃ¡tico</strong> antes da migraÃ§Ã£o</li>
            <li>âœ… <strong>Logs detalhados</strong> de todo o processo</li>
            <li>âœ… <strong>Processamento em lotes</strong> para grandes volumes</li>
            <li>âœ… <strong>Mapeamento flexÃ­vel</strong> de campos</li>
            <li>âœ… <strong>PreservaÃ§Ã£o dos dados originais</strong></li>
        </ul>

        <h3>Casos de Uso</h3>
        <ul>
            <li>MigraÃ§Ã£o de sistemas legados</li>
            <li>MudanÃ§a de arquitetura de dados</li>
            <li>IntegraÃ§Ã£o entre sistemas</li>
            <li>Backup estruturado de dados NoSQL</li>
        </ul>
    </section>

    <section id="arquitetura">
        <h1>ğŸ—ï¸ ARQUITETURA DO SISTEMA</h1>

        <pre>
graph TD
    A[MongoDB] --> B[Python Migrator]
    B --> C[ValidaÃ§Ã£o de Dados]
    C --> D[Mapeamento de Campos]
    D --> E[MySQL]
    B --> F[Sistema de Logs]
    B --> G[Backup System]
    E --> H[VerificaÃ§Ã£o de Integridade]
        </pre>

        <h3>Componentes Principais</h3>
        <ol>
            <li><strong>Conector MongoDB</strong> - ExtraÃ§Ã£o de dados</li>
            <li><strong>Validador de Dados</strong> - Limpeza e validaÃ§Ã£o</li>
            <li><strong>Mapeador de Campos</strong> - ConversÃ£o de estruturas</li>
            <li><strong>Conector MySQL</strong> - InserÃ§Ã£o de dados</li>
            <li><strong>Sistema de Logs</strong> - Monitoramento</li>
            <li><strong>Sistema de Backup</strong> - SeguranÃ§a</li>
        </ol>
    </section>

    <section id="pre-requisitos">
        <h1>ğŸ“‹ PRÃ‰-REQUISITOS</h1>

        <h3>Software NecessÃ¡rio</h3>
        <ul>
            <li><strong>Python 3.8+</strong></li>
            <li><strong>MongoDB 4.0+</strong> (rodando)</li>
            <li><strong>MySQL 8.0+</strong> (rodando)</li>
            <li><strong>pip</strong> (gerenciador de pacotes Python)</li>
        </ul>

        <h3>Conhecimentos Recomendados</h3>
        <ul>
            <li>BÃ¡sico de Python</li>
            <li>Conceitos de banco de dados</li>
            <li>Estruturas JSON</li>
            <li>SQL bÃ¡sico</li>
        </ul>

        <h3>Hardware MÃ­nimo</h3>
        <ul>
            <li><strong>RAM</strong>: 4GB (8GB recomendado)</li>
            <li><strong>EspaÃ§o</strong>: 2GB livres</li>
            <li><strong>CPU</strong>: Dual-core</li>
        </ul>
    </section>

    <section id="instalacao">
        <h1>ğŸ› ï¸ INSTALAÃ‡ÃƒO E CONFIGURAÃ‡ÃƒO</h1>

        <h3>1. PreparaÃ§Ã£o do Ambiente</h3>

        <pre>
# 1. Criar diretÃ³rio do projeto
mkdir migracao-mongodb-mysql
cd migracao-mongodb-mysql

# 2. Criar ambiente virtual Python
python -m venv venv

# 3. Ativar ambiente virtual
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 4. Criar estrutura de pastas
mkdir -p {config,logs,backup,dados,scripts,tests}
        </pre>

        <h3>2. InstalaÃ§Ã£o de DependÃªncias</h3>

        <p><strong>Arquivo: <code>requirements.txt</code></strong></p>
        <pre>
# Conectores de banco de dados
pymongo==4.6.0
mysql-connector-python==8.2.0

# ManipulaÃ§Ã£o de dados
pandas==2.1.4
numpy==1.24.3

# ConfiguraÃ§Ã£o e ambiente
python-dotenv==1.0.0
pyyaml==6.0.1

# ValidaÃ§Ã£o de dados
jsonschema==4.20.0
cerberus==1.3.5

# Logs e monitoramento
colorlog==6.8.0
tqdm==4.66.1

# UtilitÃ¡rios
click==8.1.7
tabulate==0.9.0

# Testes (opcional)
pytest==7.4.3
pytest-cov==4.1.0
        </pre>

        <pre>
# Instalar dependÃªncias
pip install -r requirements.txt
        </pre>

        <h3>3. ConfiguraÃ§Ã£o de Ambiente</h3>

        <p><strong>Arquivo: <code>.env</code></strong></p>
        <pre>
# ===========================================
# CONFIGURAÃ‡Ã•ES MONGODB
# ===========================================
MONGO_HOST=localhost
MONGO_PORT=27017
MONGO_DATABASE=seu_banco_mongo
MONGO_USERNAME=
MONGO_PASSWORD=
MONGO_AUTH_SOURCE=admin

# ===========================================
# CONFIGURAÃ‡Ã•ES MYSQL
# ===========================================
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_DATABASE=seu_banco_mysql
MYSQL_USERNAME=root
MYSQL_PASSWORD=
MYSQL_CHARSET=utf8mb4

# ===========================================
# CONFIGURAÃ‡Ã•ES DE MIGRAÃ‡ÃƒO
# ===========================================
BATCH_SIZE=1000
MAX_RETRIES=3
BACKUP_ENABLED=true
VALIDATE_DATA=true
LOG_LEVEL=INFO
PRESERVE_ORIGINAL_DATA=true

# ===========================================
# CONFIGURAÃ‡Ã•ES DE SEGURANÃ‡A
# ===========================================
ENCRYPTION_KEY=sua_chave_secreta_aqui
BACKUP_RETENTION_DAYS=30
        </pre>
    </section>

    <section id="estrutura">
        <h1>ğŸ“ ESTRUTURA DO PROJETO</h1>

        <pre>
ğŸ“ migracao-mongodb-mysql/
â”œâ”€â”€ ğŸ“„ README.md
â”œâ”€â”€ ğŸ“„ requirements.txt
â”œâ”€â”€ ğŸ“„ .env
â”œâ”€â”€ ğŸ“„ .gitignore
â”œâ”€â”€ ğŸ“„ main.py                    # Script principal
â”œâ”€â”€ ğŸ“ config/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”œâ”€â”€ ğŸ“„ settings.py            # ConfiguraÃ§Ãµes
â”‚   â”œâ”€â”€ ğŸ“„ database.py            # ConexÃµes de banco
â”‚   â””â”€â”€ ğŸ“„ mappings.yaml          # Mapeamentos de dados
â”œâ”€â”€ ğŸ“ src/
â”‚   â”œâ”€â”€ ğŸ“„ __init__.py
â”‚   â”œâ”€â”€ ğŸ“„ migrator.py            # Classe principal
â”‚   â”œâ”€â”€ ğŸ“„ validators.py          # Validadores de dados
â”‚   â”œâ”€â”€ ğŸ“„ transformers.py        # Transformadores de dados
â”‚   â”œâ”€â”€ ğŸ“„ backup.py              # Sistema de backup
â”‚   â””â”€â”€ ğŸ“„ utils.py               # UtilitÃ¡rios
â”œâ”€â”€ ğŸ“ logs/
â”‚   â”œâ”€â”€ ğŸ“„ migration.log
â”‚   â”œâ”€â”€ ğŸ“„ errors.log
â”‚   â””â”€â”€ ğŸ“„ performance.log
â”œâ”€â”€ ğŸ“ backup/
â”‚   â”œâ”€â”€ ğŸ“„ mysql_backup_YYYYMMDD.sql
â”‚   â””â”€â”€ ğŸ“„ mongodb_export_YYYYMMDD.json
â”œâ”€â”€ ğŸ“ dados/
â”‚   â”œâ”€â”€ ğŸ“„ sample_data.json
â”‚   â””â”€â”€ ğŸ“„ test_data.json
â”œâ”€â”€ ğŸ“ scripts/
â”‚   â”œâ”€â”€ ğŸ“„ setup_mysql.sql        # Scripts SQL
â”‚   â”œâ”€â”€ ğŸ“„ cleanup.py             # Limpeza
â”‚   â””â”€â”€ ğŸ“„ verify.py              # VerificaÃ§Ã£o
â””â”€â”€ ğŸ“ tests/
    â”œâ”€â”€ ğŸ“„ test_migrator.py
    â”œâ”€â”€ ğŸ“„ test_validators.py
    â””â”€â”€ ğŸ“„ test_integration.py
        </pre>
    </section>

    <section id="implementacao">
        <h1>ğŸ’» IMPLEMENTAÃ‡ÃƒO COMPLETA</h1>

        <h3>1. ConfiguraÃ§Ãµes (config/settings.py)</h3>

        <pre>
"""
ConfiguraÃ§Ãµes do sistema de migraÃ§Ã£o
"""
import os
from dotenv import load_dotenv
from typing import Dict, Any

load_dotenv()

class Config:
    """Classe de configuraÃ§Ãµes centralizadas"""
    
    # MongoDB
    MONGO_CONFIG = {
        'host': os.getenv('MONGO_HOST', 'localhost'),
        'port': int(os.getenv('MONGO_PORT', 27017)),
        'database': os.getenv('MONGO_DATABASE', 'test'),
        'username': os.getenv('MONGO_USERNAME'),
        'password': os.getenv('MONGO_PASSWORD'),
        'auth_source': os.getenv('MONGO_AUTH_SOURCE', 'admin'),
    }
    
    # MySQL
    MYSQL_CONFIG = {
        'host': os.getenv('MYSQL_HOST', 'localhost'),
        'port': int(os.getenv('MYSQL_PORT', 3306)),
        'database': os.getenv('MYSQL_DATABASE', 'test'),
        'user': os.getenv('MYSQL_USERNAME', 'root'),
        'password': os.getenv('MYSQL_PASSWORD', ''),
        'charset': os.getenv('MYSQL_CHARSET', 'utf8mb4'),
        'autocommit': False,
        'raise_on_warnings': True
    }
    
    # MigraÃ§Ã£o
    MIGRATION_CONFIG = {
        'batch_size': int(os.getenv('BATCH_SIZE', 1000)),
        'max_retries': int(os.getenv('MAX_RETRIES', 3)),
        'backup_enabled': os.getenv('BACKUP_ENABLED', 'true').lower() == 'true',
        'validate_data': os.getenv('VALIDATE_DATA', 'true').lower() == 'true',
        'preserve_original': os.getenv('PRESERVE_ORIGINAL_DATA', 'true').lower() == 'true',
    }
    
    # Logs
    LOG_CONFIG = {
        'level': os.getenv('LOG_LEVEL', 'INFO'),
        'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        'file_rotation': True,
        'max_file_size': 10 * 1024 * 1024,  # 10MB
        'backup_count': 5
    }
    
    # DiretÃ³rios
    DIRECTORIES = {
        'logs': 'logs',
        'backup': 'backup',
        'config': 'config',
        'data': 'dados'
    }
    
    @classmethod
    def get_mongo_uri(cls) -> str:
        """Gerar URI de conexÃ£o MongoDB"""
        config = cls.MONGO_CONFIG
        
        if config['username'] and config['password']:
            return f"mongodb://{config['username']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}?authSource={config['auth_source']}"
        else:
            return f"mongodb://{config['host']}:{config['port']}/{config['database']}"
    
    @classmethod
    def validate_config(cls) -> bool:
        """Validar configuraÃ§Ãµes"""
        required_vars = [
            'MONGO_DATABASE',
            'MYSQL_DATABASE'
        ]
        
        missing_vars = []
        for var in required_vars:
            if not os.getenv(var):
                missing_vars.append(var)
        
        if missing_vars:
            raise ValueError(f"VariÃ¡veis de ambiente obrigatÃ³rias nÃ£o definidas: {missing_vars}")
        
        return True
        </pre>

        <h3>2. ConexÃµes de Banco (config/database.py)</h3>

        <pre>
"""
Gerenciadores de conexÃ£o com bancos de dados
"""
import pymongo
import mysql.connector
from mysql.connector import Error as MySQLError
from pymongo.errors import ConnectionFailure, ServerSelectionTimeoutError
from typing import Optional
import logging
from .settings import Config

logger = logging.getLogger(__name__)

class MongoDBConnection:
    """Gerenciador de conexÃ£o MongoDB"""
    
    def __init__(self):
        self.client: Optional[pymongo.MongoClient] = None
        self.database = None
        
    def connect(self) -> bool:
        """Estabelecer conexÃ£o com MongoDB"""
        try:
            uri = Config.get_mongo_uri()
            self.client = pymongo.MongoClient(
                uri,
                serverSelectionTimeoutMS=5000,  # 5 segundos timeout
                connectTimeoutMS=10000,         # 10 segundos timeout
                socketTimeoutMS=20000           # 20 segundos timeout
            )
            
            # Testar conexÃ£o
            self.client.admin.command('ping')
            self.database = self.client[Config.MONGO_CONFIG['database']]
            
            logger.info("âœ… ConexÃ£o MongoDB estabelecida com sucesso")
            return True
            
        except (ConnectionFailure, ServerSelectionTimeoutError) as e:
            logger.error(f"âŒ Erro ao conectar MongoDB: {e}")
            return False
        except Exception as e:
            logger.error(f"âŒ Erro inesperado MongoDB: {e}")
            return False
    
    def get_collection(self, name: str):
        """Obter coleÃ§Ã£o"""
        if not self.database:
            raise RuntimeError("ConexÃ£o MongoDB nÃ£o estabelecida")
        return self.database[name]
    
    def list_collections(self) -> list:
        """Listar coleÃ§Ãµes disponÃ­veis"""
        if not self.database:
            return []
        return self.database.list_collection_names()
    
    def get_collection_stats(self, collection_name: str) -> dict:
        """Obter estatÃ­sticas da coleÃ§Ã£o"""
        if not self.database:
            return {}
        
        try:
            stats = self.database.command("collStats", collection_name)
            return {
                'count': stats.get('count', 0),
                'size': stats.get('size', 0),
                'avgObjSize': stats.get('avgObjSize', 0)
            }
        except Exception as e:
            logger.warning(f"NÃ£o foi possÃ­vel obter stats de {collection_name}: {e}")
            return {}
    
    def close(self):
        """Fechar conexÃ£o"""
        if self.client:
            self.client.close()
            logger.info("ğŸ”’ ConexÃ£o MongoDB fechada")

class MySQLConnection:
    """Gerenciador de conexÃ£o MySQL"""
    
    def __init__(self):
        self.connection: Optional[mysql.connector.MySQLConnection] = None
        self.cursor = None
        
    def connect(self) -> bool:
        """Estabelecer conexÃ£o com MySQL"""
        try:
            self.connection = mysql.connector.connect(**Config.MYSQL_CONFIG)
            self.cursor = self.connection.cursor(dictionary=True)
            
            # Testar conexÃ£o
            self.cursor.execute("SELECT 1")
            self.cursor.fetchone()
            
            logger.info("âœ… ConexÃ£o MySQL estabelecida com sucesso")
            return True
            
        except MySQLError as e:
            logger.error(f"âŒ Erro ao conectar MySQL: {e}")
            return False
        except Exception as e:
            logger.error(f"âŒ Erro inesperado MySQL: {e}")
            return False
    
    def execute_query(self, query: str, params: tuple = None) -> list:
        """Executar query SELECT"""
        if not self.cursor:
            raise RuntimeError("ConexÃ£o MySQL nÃ£o estabelecida")
        
        try:
            self.cursor.execute(query, params)
            return self.cursor.fetchall()
        except MySQLError as e:
            logger.error(f"Erro ao executar query: {e}")
            raise
    
    def execute_insert(self, query: str, params: tuple = None) -> int:
        """Executar INSERT e retornar ID"""
        if not self.cursor:
            raise RuntimeError("ConexÃ£o MySQL nÃ£o estabelecida")
        
        try:
            self.cursor.execute(query, params)
            return self.cursor.lastrowid
        except MySQLError as e:
            logger.error(f"Erro ao executar insert: {e}")
            raise
    
    def execute_many(self, query: str, params_list: list) -> int:
        """Executar mÃºltiplos INSERTs"""
        if not self.cursor:
            raise RuntimeError("ConexÃ£o MySQL nÃ£o estabelecida")
        
        try:
            self.cursor.executemany(query, params_list)
            return self.cursor.rowcount
        except MySQLError as e:
            logger.error(f"Erro ao executar batch insert: {e}")
            raise
    
    def commit(self):
        """Confirmar transaÃ§Ã£o"""
        if self.connection:
            self.connection.commit()
    
    def rollback(self):
        """Reverter transaÃ§Ã£o"""
        if self.connection:
            self.connection.rollback()
    
    def close(self):
        """Fechar conexÃ£o"""
        if self.cursor:
            self.cursor.close()
        if self.connection:
            self.connection.close()
        logger.info("ğŸ”’ ConexÃ£o MySQL fechada")

class DatabaseManager:
    """Gerenciador centralizado de conexÃµes"""
    
    def __init__(self):
        self.mongo = MongoDBConnection()
        self.mysql = MySQLConnection()
        self.connected = False
    
    def connect_all(self) -> bool:
        """Conectar todos os bancos"""
        mongo_ok = self.mongo.connect()
        mysql_ok = self.mysql.connect()
        
        self.connected = mongo_ok and mysql_ok
        
        if self.connected:
            logger.info("ğŸ‰ Todas as conexÃµes estabelecidas com sucesso")
        else:
            logger.error("âŒ Falha ao estabelecer conexÃµes")
        
        return self.connected
    
    def close_all(self):
        """Fechar todas as conexÃµes"""
        self.mongo.close()
        self.mysql.close()
        self.connected = False
        logger.info("ğŸ”’ Todas as conexÃµes fechadas")
        </pre>

        <h3>3. Mapeamentos de Dados (config/mappings.yaml)</h3>

        <pre>
# ===========================================
# MAPEAMENTOS DE COLEÃ‡Ã•ES MONGODB â†’ MYSQL
# ===========================================

# ConfiguraÃ§Ã£o para usuÃ¡rios
usuarios:
  mysql_table: "usuarios"
  create_table: true
  fields:
    _id: 
      mysql_field: "mongo_id"
      mysql_type: "VARCHAR(24)"
      transform: "str"
    nome:
      mysql_field: "nome"
      mysql_type: "VARCHAR(100)"
      required: true
      validate: "not_empty"
    email:
      mysql_field: "email"
      mysql_type: "VARCHAR(100)"
      required: true
      validate: "email"
      unique: true
    telefone:
      mysql_field: "telefone"
      mysql_type: "VARCHAR(20)"
      transform: "clean_phone"
    idade:
      mysql_field: "idade"
      mysql_type: "INT"
      validate: "positive_int"
    data_cadastro:
      mysql_field: "data_cadastro"
      mysql_type: "TIMESTAMP"
      default: "CURRENT_TIMESTAMP"
    ativo:
      mysql_field: "ativo"
      mysql_type: "BOOLEAN"
      default: true
  indexes:
    - fields: ["email"]
      unique: true
    - fields: ["mongo_id"]
      unique: true
  preserve_original: true

# ConfiguraÃ§Ã£o para produtos
produtos:
  mysql_table: "produtos"
  create_table: true
  fields:
    _id:
      mysql_field: "mongo_id"
      mysql_type: "VARCHAR(24)"
      transform: "str"
    nome:
      mysql_field: "nome"
      mysql_type: "VARCHAR(200)"
      required: true
    descricao:
      mysql_field: "descricao"
      mysql_type: "TEXT"
    preco:
      mysql_field: "preco"
      mysql_type: "DECIMAL(10,2)"
      validate: "positive_decimal"
      transform: "to_decimal"
    categoria:
      mysql_field: "categoria"
      mysql_type: "VARCHAR(100)"
    tags:
      mysql_field: "tags"
      mysql_type: "JSON"
      transform: "array_to_json"
    ativo:
      mysql_field: "ativo"
      mysql_type: "BOOLEAN"
      default: true
    data_criacao:
      mysql_field: "data_criacao"
      mysql_type: "TIMESTAMP"
      default: "CURRENT_TIMESTAMP"
  indexes:
    - fields: ["categoria"]
    - fields: ["ativo"]
  preserve_original: true

# ConfiguraÃ§Ã£o para pedidos
pedidos:
  mysql_table: "pedidos"
  create_table: true
  fields:
    _id:
      mysql_field: "mongo_id"
      mysql_type: "VARCHAR(24)"
    numero_pedido:
      mysql_field: "numero_pedido"
      mysql_type: "VARCHAR(50)"
      unique: true
    usuario_id:
      mysql_field: "usuario_id"
      mysql_type: "VARCHAR(24)"
      required: true
    produtos:
      mysql_field: "produtos"
      mysql_type: "JSON"
      transform: "array_to_json"
    total:
      mysql_field: "total"
      mysql_type: "DECIMAL(10,2)"
      validate: "positive_decimal"
    status:
      mysql_field: "status"
      mysql_type: "ENUM('pendente','processando','enviado','entregue','cancelado')"
      default: "pendente"
    data_pedido:
      mysql_field: "data_pedido"
      mysql_type: "TIMESTAMP"
      default: "CURRENT_TIMESTAMP"
  indexes:
    - fields: ["numero_pedido"]
      unique: true
    - fields: ["usuario_id"]
    - fields: ["status"]
  preserve_original: true

# ConfiguraÃ§Ã£o para eventos/inscriÃ§Ãµes
inscricoes_eventos:
  mysql_table: "inscricoes_eventos"
  create_table: true
  fields:
    _id:
      mysql_field: "mongo_id"
      mysql_type: "VARCHAR(24)"
    nome:
      mysql_field: "nome"
      mysql_type: "VARCHAR(100)"
      required: true
    email:
      mysql_field: "email"
      mysql_type: "VARCHAR(100)"
      required: true
      validate: "email"
    telefone:
      mysql_field: "telefone"
      mysql_type: "VARCHAR(20)"
      transform: "clean_phone"
    evento:
      mysql_field: "evento"
      mysql_type: "VARCHAR(100)"
      default: "GeekFest 2025"
    tipo_ingresso:
      mysql_field: "tipo_ingresso"
      mysql_type: "ENUM('individual','vip','grupo')"
      default: "individual"
    data_inscricao:
      mysql_field: "data_inscricao"
      mysql_type: "TIMESTAMP"
      default: "CURRENT_TIMESTAMP"
    confirmado:
      mysql_field: "confirmado"
      mysql_type: "BOOLEAN"
      default: false
  indexes:
    - fields: ["email", "evento"]
      unique: true
    - fields: ["evento"]
  preserve_original: true

# ===========================================
# CONFIGURAÃ‡Ã•ES GLOBAIS
# ===========================================
global_settings:
  preserve_original_field: "dados_originais"
  preserve_original_type: "JSON"
  add_migration_timestamp: true
  migration_timestamp_field: "migrado_em"
  migration_timestamp_type: "TIMESTAMP"
  add_migration_id: true
  migration_id_field: "migracao_id"
  migration_id_type: "VARCHAR(36)"
        </pre>
    </section>

    <section id="execucao">
        <h1>ğŸš€ COMO EXECUTAR</h1>

        <h3>1. InstalaÃ§Ã£o Inicial</h3>

        <pre>
# 1. Clonar/criar projeto
git clone &lt;seu-repositorio&gt; migracao-mongodb-mysql
cd migracao-mongodb-mysql

# 2. Criar ambiente virtual
python -m venv venv
source venv/bin/activate  # Linux/Mac
# ou
venv\Scripts\activate     # Windows

# 3. Instalar dependÃªncias
pip install -r requirements.txt

# 4. Configurar ambiente
cp .env.example .env
# Editar .env com suas configuraÃ§Ãµes
        </pre>

        <h3>2. ConfiguraÃ§Ã£o</h3>

        <pre>
# Editar arquivo .env
nano .env

# Ajustar mapeamentos se necessÃ¡rio
nano config/mappings.yaml
        </pre>

        <h3>3. Testes Iniciais</h3>

        <pre>
# Testar conexÃµes
python main.py test-connections

# Criar dados de exemplo (opcional)
python main.py create-sample-data
        </pre>

        <h3>4. Executar MigraÃ§Ã£o</h3>

        <pre>
# MigraÃ§Ã£o completa
python main.py migrate

# Migrar coleÃ§Ãµes especÃ­ficas
python main.py migrate -c usuarios -c produtos

# Modo dry-run (teste sem alteraÃ§Ãµes)
python main.py migrate --dry-run

# Usar arquivo de mapeamentos personalizado
python main.py migrate -m config/meu_mapeamento.yaml
        </pre>

        <h3>5. ManutenÃ§Ã£o</h3>

        <pre>
# Limpar backups antigos
python main.py cleanup-backups --retention-days 15

# Ver logs
tail -f logs/migration.log

# Ver apenas erros
tail -f logs/errors.log
        </pre>
    </section>

    <section id="monitoramento">
        <h1>ğŸ“Š MONITORAMENTO E LOGS</h1>

        <h3>Estrutura de Logs</h3>
        <pre>
ğŸ“ logs/
â”œâ”€â”€ ğŸ“„ migration.log      # Log geral da migraÃ§Ã£o
â”œâ”€â”€ ğŸ“„ errors.log         # Apenas erros crÃ­ticos
â”œâ”€â”€ ğŸ“„ performance.log    # MÃ©tricas de performance
â””â”€â”€ ğŸ“„ validation.log     # Erros de validaÃ§Ã£o
        </pre>

        <h3>Tipos de Logs</h3>

        <h4>1. Log Geral (migration.log)</h4>
        <pre>
2024-01-15 10:30:15 - INFO - ğŸš€ Iniciando migraÃ§Ã£o - ID: abc123
2024-01-15 10:30:16 - INFO - âœ… ConexÃ£o MongoDB estabelecida
2024-01-15 10:30:17 - INFO - âœ… ConexÃ£o MySQL estabelecida
2024-01-15 10:30:18 - INFO - ğŸ—ï¸ Criando tabelas MySQL...
2024-01-15 10:30:20 - INFO - ğŸ”„ Migrando coleÃ§Ã£o: usuarios
2024-01-15 10:30:25 - INFO - âœ… ColeÃ§Ã£o 'usuarios' migrada com sucesso
        </pre>

        <h4>2. Log de Erros (errors.log)</h4>
        <pre>
2024-01-15 10:32:10 - ERROR - âŒ Documento invÃ¡lido 507f1f77bcf86cd799439011: ['Email invÃ¡lido']
2024-01-15 10:32:15 - ERROR - âŒ Erro ao inserir lote: Duplicate entry 'joao@email.com'
2024-01-15 10:32:20 - ERROR - âŒ Falha na validaÃ§Ã£o: Campo 'nome' estÃ¡ vazio
        </pre>

        <h4>3. MÃ©tricas em Tempo Real</h4>
        <pre>
# Durante a execuÃ§Ã£o, vocÃª verÃ¡:
Migrando usuarios: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1500/1500 [00:45<00:00, 33.33docs/s]
Migrando produtos: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 500/500 [00:15<00:00, 33.33docs/s]
        </pre>
    </section>

    <section id="troubleshooting">
        <h1>ğŸ”§ TROUBLESHOOTING</h1>

        <h3>Problemas Comuns e SoluÃ§Ãµes</h3>

        <h4>1. Erro de ConexÃ£o MongoDB</h4>
        <pre>
âŒ Erro: ServerSelectionTimeoutError
        </pre>
        <p><strong>SoluÃ§Ãµes:</strong></p>
        <ul>
            <li>Verificar se MongoDB estÃ¡ rodando: <code>sudo systemctl status mongod</code></li>
            <li>Testar conexÃ£o manual: <code>mongo --host localhost --port 27017</code></li>
            <li>Verificar firewall e portas</li>
            <li>Confirmar credenciais no <code>.env</code></li>
        </ul>

        <h4>2. Erro de ConexÃ£o MySQL</h4>
        <pre>
âŒ Erro: Access denied for user 'root'@'localhost'
        </pre>
        <p><strong>SoluÃ§Ãµes:</strong></p>
        <ul>
            <li>Verificar senha no <code>.env</code></li>
            <li>Resetar senha MySQL: <code>sudo mysql_secure_installation</code></li>
            <li>Verificar permissÃµes: <code>GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';</code></li>
        </ul>

        <h4>3. Erro de DependÃªncias</h4>
        <pre>
âŒ ModuleNotFoundError: No module named 'pymongo'
        </pre>
        <p><strong>SoluÃ§Ãµes:</strong></p>
        <pre>
# Ativar ambiente virtual
source venv/bin/activate

# Reinstalar dependÃªncias
pip install -r requirements.txt

# Verificar instalaÃ§Ã£o
pip list | grep pymongo
        </pre>

        <h4>4. Erro de ValidaÃ§Ã£o de Dados</h4>
        <pre>
âŒ Campo 'email' falhou na validaÃ§Ã£o 'email'
        </pre>
        <p><strong>SoluÃ§Ãµes:</strong></p>
        <ul>
            <li>Verificar dados no MongoDB: <code>db.usuarios.find({"email": {$regex: ".*@.*"}})</code></li>
            <li>Ajustar regras de validaÃ§Ã£o em <code>mappings.yaml</code></li>
            <li>Implementar limpeza de dados personalizada</li>
        </ul>

        <h4>5. Erro de EspaÃ§o em Disco</h4>
        <pre>
âŒ Erro: No space left on device
        </pre>
        <p><strong>SoluÃ§Ãµes:</strong></p>
        <pre>
# Verificar espaÃ§o
df -h

# Limpar logs antigos
python main.py cleanup-backups --retention-days 7

# Comprimir logs grandes
gzip logs/migration.log
        </pre>
    </section>

    <section id="extensoes">
        <h1>ğŸš€ EXTENSÃ•ES E MELHORIAS</h1>

        <h3>1. Interface Web (Flask)</h3>

        <p><strong>Arquivo: <code>web/app.py</code></strong></p>
        <pre>
from flask import Flask, render_template, request, jsonify
import threading
from src.migrator import MongoToMySQLMigrator

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/migrate', methods=['POST'])
def start_migration():
    collections = request.json.get('collections', [])
    
    def run_migration():
        migrator = MongoToMySQLMigrator()
        migrator.run_migration(collections)
    
    thread = threading.Thread(target=run_migration)
    thread.start()
    
    return jsonify({'status': 'started'})

@app.route('/api/status')
def migration_status():
    # Implementar status da migraÃ§Ã£o
    return jsonify({'status': 'running', 'progress': 45})

if __name__ == '__main__':
    app.run(debug=True)
        </pre>

        <h3>2. Monitoramento com Grafana</h3>

        <p><strong>Arquivo: <code>monitoring/metrics.py</code></strong></p>
        <pre>
import time
import json
from prometheus_client import Counter, Histogram, Gauge

# MÃ©tricas Prometheus
documents_processed = Counter('migration_documents_processed_total')
migration_duration = Histogram('migration_duration_seconds')
active_migrations = Gauge('migration_active_count')

class MetricsCollector:
    def __init__(self):
        self.start_time = time.time()
    
    def record_document_processed(self):
        documents_processed.inc()
    
    def record_migration_complete(self):
        duration = time.time() - self.start_time
        migration_duration.observe(duration)
        </pre>

        <h3>3. NotificaÃ§Ãµes (Slack/Email)</h3>

        <p><strong>Arquivo: <code>notifications/notifier.py</code></strong></p>
        <pre>
import smtplib
import requests
from email.mime.text import MIMEText

class NotificationManager:
    def __init__(self):
        self.slack_webhook = os.getenv('SLACK_WEBHOOK_URL')
        self.email_config = {
            'smtp_server': os.getenv('SMTP_SERVER'),
            'smtp_port': int(os.getenv('SMTP_PORT', 587)),
            'username': os.getenv('SMTP_USERNAME'),
            'password': os.getenv('SMTP_PASSWORD')
        }
    
    def send_slack_notification(self, message):
        if self.slack_webhook:
            payload = {'text': message}
            requests.post(self.slack_webhook, json=payload)
    
    def send_email_notification(self, subject, message, to_email):
        msg = MIMEText(message)
        msg['Subject'] = subject
        msg['From'] = self.email_config['username']
        msg['To'] = to_email
        
        with smtplib.SMTP(self.email_config['smtp_server'], self.email_config['smtp_port']) as server:
            server.starttls()
            server.login(self.email_config['username'], self.email_config['password'])
            server.send_message(msg)
    
    def notify_migration_complete(self, statistics):
        message = f"""
        ğŸ‰ MigraÃ§Ã£o ConcluÃ­da!
        
        ğŸ“Š EstatÃ­sticas:
        - Documentos migrados: {statistics['migrated_successfully']}
        - Falhas: {statistics['failed_migrations']}
        - DuraÃ§Ã£o: {statistics['end_time'] - statistics['start_time']}
        """
        
        self.send_slack_notification(message)
        self.send_email_notification("MigraÃ§Ã£o ConcluÃ­da", message, "admin@empresa.com")
        </pre>
    </section>

    <section id="conclusao">
        <h1>ğŸ¯ CONCLUSÃƒO</h1>

        <p>Esta documentaÃ§Ã£o fornece um sistema completo e robusto para migraÃ§Ã£o de dados MongoDB â†’ MySQL. O sistema oferece:</p>

        <h3>CaracterÃ­sticas Principais:</h3>
        <ul>
            <li>âœ… <strong>AutomaÃ§Ã£o completa</strong> do processo</li>
            <li>âœ… <strong>ValidaÃ§Ã£o rigorosa</strong> de dados</li>
            <li>âœ… <strong>Backup automÃ¡tico</strong> para seguranÃ§a</li>
            <li>âœ… <strong>Logs detalhados</strong> para auditoria</li>
            <li>âœ… <strong>Processamento em lotes</strong> para performance</li>
            <li>âœ… <strong>RecuperaÃ§Ã£o de erros</strong> robusta</li>
            <li>âœ… <strong>Extensibilidade</strong> para futuras necessidades</li>
        </ul>

        <h3>BenefÃ­cios:</h3>
        <ul>
            <li><strong>Reduz tempo</strong> de migraÃ§Ã£o manual</li>
            <li><strong>Minimiza erros</strong> humanos</li>
            <li><strong>Garante integridade</strong> dos dados</li>
            <li><strong>Fornece rastreabilidade</strong> completa</li>
            <li><strong>Permite rollback</strong> se necessÃ¡rio</li>
        </ul>

        <h3>PrÃ³ximos Passos:</h3>
        <ol>
            <li>Implementar o sistema bÃ¡sico</li>
            <li>Testar com seus dados reais</li>
            <li>Ajustar mapeamentos conforme necessÃ¡rio</li>
            <li>Adicionar extensÃµes conforme demanda</li>
            <li>Configurar monitoramento em produÃ§Ã£o</li>
        </ol>

        <div class="success-box">
            <p>Este sistema foi projetado para ser <strong>flexÃ­vel, seguro e escalÃ¡vel</strong>, permitindo que vocÃª migre seus dados com confianÃ§a e controle total sobre o processo.</p>
        </div>
    </section>

    <footer style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center; color: #64748b;">
        <p>DocumentaÃ§Ã£o do Sistema de MigraÃ§Ã£o MongoDB â†’ MySQL</p>
        <p>Â© 2024 - Todos os direitos reservados</p>
    </footer>
</body>
</html>
