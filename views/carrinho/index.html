<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho | xNeedWare</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
  <link rel="stylesheet" href="/css/carrinho.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/footer.css">
  <style>
    /* Estilos para a barra lateral fixa */
    .checkout-sidebar {
      position: sticky;
      top: 20px;
      height: fit-content;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    /* Melhorias no carrinho */
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 10px;
      background: white;
    }

    .cart-item-info h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    .cart-item-info p {
      margin: 0;
      color: #666;
    }

    .qtd-input {
      width: 60px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .remover-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .remover-btn:hover {
      background: #cc0000;
    }

    /* Steps do formulﾃ｡rio */
    .form-step {
      transition: opacity 0.3s ease;
    }

    .form-step.hidden {
      display: none;
    }

    .form-step.active {
      display: block;
    }

    /* Progress bar */
    .progress-step.active .step-number {
      background: #007bff;
      color: white;
    }

    .progress-step.active .step-text {
      color: #007bff;
      font-weight: 600;
    }

    /* Estilos para seleﾃｧﾃ｣o de mﾃｩtodo de pagamento */
    .payment-methods-selection {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .payment-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 0;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .payment-option:hover {
      border-color: #c0c0c0;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .payment-option.selected {
      border-color: #007bff;
      background: #f8fbff;
    }

    .payment-option-header {
      display: flex;
      align-items: center;
      padding: 20px;
      gap: 15px;
    }

    .payment-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 10px;
      font-size: 1.5rem;
    }

    .payment-option[data-method="google-pay"] .payment-icon {
      color: #4285f4;
      background: #e8f0fe;
    }

    .payment-info {
      flex: 1;
    }

    .payment-info h3 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
    }

    .payment-info p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }

    .payment-radio {
      position: relative;
      width: 20px;
      height: 20px;
    }

    .payment-radio input[type="radio"] {
      opacity: 0;
      position: absolute;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .radio-checkmark {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      border: 2px solid #ccc;
      border-radius: 50%;
      background: white;
      transition: all 0.3s ease;
    }

    .payment-radio input[type="radio"]:checked + .radio-checkmark {
      border-color: #007bff;
      background: #007bff;
    }

    .payment-radio input[type="radio"]:checked + .radio-checkmark::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }

    .payment-option-details {
      padding: 0 20px 20px 20px;
      border-top: 1px solid #f0f0f0;
      margin-top: 0;
      text-align: center;
    }

    .payment-option-details.hidden {
      display: none;
    }

    .payment-security {
      color: #28a745;
      font-size: 0.9rem;
      margin: 10px 0;
    }

    /* Garantir que o botﾃ｣o do Google Pay seja visﾃｭvel */
    .gpay-button {
      width: 100% !important;
      height: 40px !important;
      max-width: 300px;
      margin: 0 auto;
    }

    /* Loading spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <header class="xneedware-header">
    <div class="header-container">
      <a href="/" class="logo">
        <span class="logo-x">x</span><span class="logo-text">NeedWare</span>
      </a>

      <button class="menu-toggle" id="mobile-menu">
        <i class="fas fa-bars"></i>
      </button>

      <nav class="main-nav">
        <ul>
          <li><a href="/produtos">Produtos</a></li>
          <li><a href="/sobre">Sobre</a></li>
          <li><a href="/contato">Contato</a></li>
          <div id="usuarioArea"></div>
          <script src="/js/header-usuario.js"></script>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <h1>Seu Carrinho</h1>
      <p class="subtitle">Revise seus produtos antes de finalizar a compra.</p>
    </section>

    <section class="checkout-container">
      <div class="checkout-form">
        <div class="form-progress">
          <div class="progress-step active" data-step="0">
            <div class="step-number">1</div>
            <div class="step-text">Carrinho</div>
          </div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="1">
            <div class="step-number">2</div>
            <div class="step-text">Dados</div>
          </div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="2">
            <div class="step-number">3</div>
            <div class="step-text">Pagamento</div>
          </div>
          <div class="progress-line"></div>
          <div class="progress-step" data-step="3">
            <div class="step-number">4</div>
            <div class="step-text">Confirmaﾃｧﾃ｣o</div>
          </div>
        </div>

        <!-- STEP 0 - CARRINHO -->
        <div class="form-step active" id="step-0">
          <h2>Produtos adicionados</h2>
          <div id="carrinhoContainer" class="cart-items"></div>

          <div class="form-actions">
            <button type="button" class="btn-next" onclick="nextStep()">Continuar</button>
          </div>
        </div>

        <!-- STEP 1 - DADOS -->
        <div class="form-step hidden" id="step-1">
          <h2>Confirme seus dados</h2>

          <div class="form-group">
            <label for="nome">Nome</label>
            <span class="user-info" id="user-nome-step2"></span>
          </div>
          <div class="form-group">
            <label for="email">Email para receber o arquivo</label>
            <input type="email" id="email" name="email" required>
            <small>Vocﾃｪ pode alterar o email para receber o arquivo em outro endereﾃｧo.</small>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-back" onclick="prevStep()">Voltar</button>
            <button type="button" class="btn-next" onclick="nextStep()">Continuar</button>
          </div>
        </div>

        <!-- STEP 2 - SELEﾃﾃグ DE PAGAMENTO -->
        <div class="form-step hidden" id="step-2">
          <h2>Selecione o mﾃｩtodo de pagamento</h2>
          
          <div class="payment-methods-selection">
            <div class="payment-option selected" data-method="google-pay">
              <div class="payment-option-header">
                <div class="payment-icon">
                  <i class="fab fa-google-pay"></i>
                </div>
                <div class="payment-info">
                  <h3>Google Pay</h3>
                  <p>Pague de forma rﾃ｡pida e segura</p>
                </div>
                <div class="payment-radio">
                  <input type="radio" name="payment-method" value="google-pay" id="google-pay-radio" checked>
                  <span class="radio-checkmark"></span>
                </div>
              </div>
              <div class="payment-option-details" id="google-pay-details">
                <div class="google-pay-info">
                  <p class="payment-security">白 Seus dados de pagamento ficam protegidos</p>
                  <p><small>Vocﾃｪ serﾃ｡ redirecionado para o Google Pay ao finalizar a compra</small></p>
                </div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-back" onclick="prevStep()">Voltar</button>
            <button type="button" class="btn-next" onclick="nextStep()">Continuar</button>
          </div>
        </div>

        <!-- STEP 3 - CONFIRMAﾃﾃグ -->
        <div class="form-step hidden" id="step-3">
          <h2>Confirme seu pedido</h2>
          
          <div class="order-summary">
            <h3>Resumo da compra</h3>
            <div class="summary-item">
              <div class="summary-label">Produto</div>
              <div class="summary-value" id="summary-product"></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Forma de pagamento</div>
              <div class="summary-value" id="summary-payment">Google Pay</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Email para entrega</div>
              <div class="summary-value" id="summary-email"></div>
            </div>
            <div class="summary-item total">
              <div class="summary-label">Total</div>
              <div class="summary-value" id="summary-total">R$ 00,00</div>
            </div>
          </div>
          
          <div class="terms-agreement">
            <label class="checkbox-container">
              <input type="checkbox" id="terms" name="terms" required>
              <span class="checkmark"></span>
              <span>Concordo com os <a href="#" class="terms-link">Termos de Serviﾃｧo</a> e <a href="#" class="terms-link">Polﾃｭtica de Privacidade</a></span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-back" onclick="prevStep()">Voltar</button>
            <button type="button" class="btn-submit" onclick="iniciarPagamentoGooglePay()">Finalizar compra</button>
          </div>
        </div>
      </div>

      <!-- BARRA LATERAL FIXA -->
      <div class="checkout-sidebar">
        <div class="order-summary-card">
          <h3>Resumo do pedido</h3>
          <div id="sidebar-products"></div>
          <div class="summary-item total">
            <div class="summary-label">Total</div>
            <div class="summary-value" id="sidebar-total">R$ 00,00</div>
          </div>
        </div>

        <div class="secure-payment">
          <div class="secure-icon">白</div>
          <p>Pagamento 100% seguro</p>
        </div>

        <div class="help-section">
          <h4>Precisa de ajuda?</h4>
          <p>Entre em contato com nosso suporte:</p>
          <a href="mailto:suporte@xneedware.com" class="support-link">suporte@xneedware.com</a>
          <a href="tel:+551199999999" class="support-link">+55 11 9999-9999</a>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-about">
          <a href="/" class="logo">
            <span class="logo-x">x</span><span class="logo-text">NeedWare</span>
          </a>

          <p class="footer-description">
            Transformando empresas atravﾃｩs de soluﾃｧﾃｵes de software inovadoras e eficientes.
          </p>

          <div class="social-links">
            <a href="https://www.instagram.com/xneedware/" class="social-link"><i class="fab fa-instagram"></i></a>
            <a href="https://www.linkedin.com/company/xneedware/posts/?feedView=all" class="social-link"><i class="fab fa-linkedin-in"></i></a>
            <a href="https://github.com/Projeto-xNeedWare" class="social-link"><i class="fab fa-github"></i></a>
          </div>
        </div>

        <div class="footer-links">
          <h3 class="footer-title">Produtos</h3>
          <ul>
            <li><a href="/chatbot">xNeed Chatbot</a></li>
            <li><a href="/downloader">xNeed Downloader</a></li>
            <li><a href="/message">xNeed Message</a></li>
            <li><a href="/qrgenerator">xNeed QrGenerator</a></li>
            <li><a href="/excel">xNeed Excel</a></li>
            <li><a href="/manager">xNeed Manager</a></li>
          </ul>
        </div>

        <div class="footer-links">
          <h3 class="footer-title">Empresa</h3>
          <ul>
            <li><a href="/sobre">Sobre Nﾃｳs</a></li>
          </ul>
        </div>

        <div class="footer-links">
          <h3 class="footer-title">Suporte</h3>
          <ul>
            <li><a href="/politica_privacidade">Polﾃｭtica de Privacidade</a></li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p>&copy; <span id="currentYear"></span> xNeedWare. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <script>
    let currentStep = 0;
    let paymentsClient = null;

    // ==================== CONFIGURAﾃﾃグ GOOGLE PAY ====================
    const baseRequest = {
        apiVersion: 2,
        apiVersionMinor: 0
    };

    const allowedPaymentMethods = [{
        type: 'CARD',
        parameters: {
            allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
            allowedCardNetworks: ['MASTERCARD', 'VISA']
        },
        tokenizationSpecification: {
            type: 'PAYMENT_GATEWAY',
            parameters: {
                gateway: 'example',
                gatewayMerchantId: 'exampleGatewayMerchantId'
            }
        }
    }];

    // ==================== INICIALIZAﾃﾃグ GOOGLE PAY ====================
    function initializeGooglePay() {
        if (window.google && window.google.payments) {
            paymentsClient = new google.payments.api.PaymentsClient({
                environment: 'TEST' // Mude para 'PRODUCTION' em produﾃｧﾃ｣o
            });

            console.log('Google Pay inicializado com sucesso');
        } else {
            console.log('Google Pay API nﾃ｣o carregada, tentando novamente...');
            setTimeout(initializeGooglePay, 500);
        }
    }

    // ==================== PROCESSAR PAGAMENTO GOOGLE PAY ====================
    function iniciarPagamentoGooglePay() {
        if (!validateCurrentStep()) return;

        console.log('Iniciando pagamento Google Pay...');

        // Mostra loading
        const submitBtn = document.querySelector('.btn-submit');
        const originalText = submitBtn.textContent;
        submitBtn.innerHTML = '<div class="loading-spinner"></div>';
        submitBtn.disabled = true;

        if (!paymentsClient) {
            console.error('Google Pay nﾃ｣o inicializado');
            showPaymentError();
            return;
        }

        const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
        if (carrinho.length === 0) {
            alert('Seu carrinho estﾃ｡ vazio.');
            return;
        }

        const total = calcularTotalCarrinho();

        const paymentDataRequest = {
            ...baseRequest,
            allowedPaymentMethods,
            transactionInfo: {
                totalPriceStatus: 'FINAL',
                totalPriceLabel: 'Total',
                totalPrice: total.toFixed(2),
                currencyCode: 'BRL',
                countryCode: 'BR'
            },
            merchantInfo: {
                merchantId: 'BCR2DN4T26QN5K5L',
                merchantName: 'xNeedWare'
            }
        };

        // Verifica se o Google Pay estﾃ｡ disponﾃｭvel
        paymentsClient.isReadyToPay({
            ...baseRequest,
            allowedPaymentMethods
        })
        .then(function(response) {
            if (response.result) {
                // Inicia o fluxo de pagamento
                paymentsClient.loadPaymentData(paymentDataRequest)
                    .then(function(paymentData) {
                        console.log('Pagamento processado com sucesso:', paymentData);
                        processarPagamentoSucesso(paymentData);
                    })
                    .catch(function(err) {
                        console.error('Erro no pagamento Google Pay:', err);
                        if (err.statusCode === 'CANCELED') {
                            console.log('Usuﾃ｡rio cancelou o pagamento');
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        } else {
                            showPaymentError();
                        }
                    });
            } else {
                console.log('Google Pay nﾃ｣o disponﾃｭvel neste dispositivo');
                showPaymentError();
            }
        })
        .catch(function(err) {
            console.error('Erro ao verificar Google Pay:', err);
            showPaymentError();
        });
    }

    function processarPagamentoSucesso(paymentData) {
        const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
        const total = calcularTotalCarrinho();
        
        // Envia para histﾃｳrico
        carrinho.forEach(item => {
            fetch('/api/historico-pagamento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    produto: item.nome,
                    valor: item.preco,
                    quantidade: item.quantidade,
                    total: total,
                    metodo: 'google-pay'
                })
            }).catch(err => console.error('Erro ao salvar histﾃｳrico:', err));
        });

        // Limpa carrinho apﾃｳs compra
        localStorage.removeItem("carrinho");
        
        // Mostra confirmaﾃｧﾃ｣o de sucesso
        const step3 = document.getElementById('step-3');
        if (step3) {
            step3.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 4rem; color: #28a745; margin-bottom: 20px;">
                        笨
                    </div>
                    <h2 style="color: #28a745; margin-bottom: 15px;">Pagamento Aprovado!</h2>
                    <p style="color: #666; margin-bottom: 25px;">
                        Seu pagamento de <strong>R$ ${total.toFixed(2)}</strong> 
                        foi processado com sucesso via Google Pay.
                    </p>
                    <p style="color: #666; font-size: 14px; margin-bottom: 30px;">
                        Vocﾃｪ receberﾃ｡ um email com as instruﾃｧﾃｵes de download em breve.
                    </p>
                    <button onclick="window.location.href='/conta/pedidos'" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        font-weight: 600;
                        margin: 5px;
                    ">
                        Ver Meus Pedidos
                    </button>
                    <button onclick="window.location.href='/produtos'" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        font-weight: 600;
                        margin: 5px;
                    ">
                        Continuar Comprando
                    </button>
                </div>
            `;
        }
    }

    function showPaymentError() {
        const submitBtn = document.querySelector('.btn-submit');
        submitBtn.textContent = 'Tentar Novamente';
        submitBtn.disabled = false;
        
        alert('Erro ao processar pagamento com Google Pay. Por favor, tente novamente ou entre em contato com o suporte.');
    }

    // ==================== SISTEMA DE STEPS ====================
    function showStep(step) {
        document.querySelectorAll('.form-step').forEach(el => {
            el.classList.add('hidden');
            el.classList.remove('active');
        });
        
        const currentStepEl = document.getElementById(`step-${step}`);
        if (currentStepEl) {
            currentStepEl.classList.remove('hidden');
            currentStepEl.classList.add('active');
        }
        
        updateProgress(step);
        currentStep = step;
    }

    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < 3) {
                showStep(currentStep + 1);
                
                if (currentStep === 3) {
                    updateFinalSummary();
                }
            }
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            showStep(currentStep - 1);
        }
    }

    function updateProgress(step) {
        document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
            if (index <= step) {
                stepEl.classList.add('active');
            } else {
                stepEl.classList.remove('active');
            }
        });
    }

    function validateCurrentStep() {
        switch(currentStep) {
            case 0:
                const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
                if (carrinho.length === 0) {
                    alert('Seu carrinho estﾃ｡ vazio. Adicione produtos antes de continuar.');
                    return false;
                }
                return true;
                
            case 1:
                const email = document.getElementById('email');
                if (!email || !email.value.trim()) {
                    alert('Por favor, informe um email vﾃ｡lido.');
                    email.focus();
                    return false;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.value)) {
                    alert('Por favor, informe um email vﾃ｡lido.');
                    email.focus();
                    return false;
                }
                return true;
                
            case 2:
                // Sem validaﾃｧﾃ｣o especﾃｭfica para seleﾃｧﾃ｣o de pagamento
                return true;
                
            case 3:
                const termsCheckbox = document.getElementById('terms');
                if (!termsCheckbox.checked) {
                    alert('Por favor, aceite os termos de serviﾃｧo.');
                    return false;
                }
                return true;
                
            default:
                return true;
        }
    }

    // ==================== SISTEMA DO CARRINHO ====================
    function atualizarCarrinho() {
        const carrinhoContainer = document.getElementById("carrinhoContainer");
        const sidebarProducts = document.getElementById("sidebar-products");
        const sidebarTotal = document.getElementById("sidebar-total");

        const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];

        carrinhoContainer.innerHTML = "";
        sidebarProducts.innerHTML = "";

        if (carrinho.length === 0) {
            carrinhoContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Seu carrinho estﾃ｡ vazio.</p>
                    <a href="/produtos" style="color: #007bff; text-decoration: none;">Continuar comprando</a>
                </div>
            `;
            sidebarTotal.textContent = "R$ 00,00";
            return;
        }

        let total = 0;

        carrinho.forEach(item => {
            const itemTotal = item.preco * item.quantidade;
            total += itemTotal;

            const div = document.createElement("div");
            div.classList.add("cart-item");
            div.innerHTML = `
                <div class="cart-item-info">
                    <h4>${item.nome}</h4>
                    <p>R$ ${item.preco.toFixed(2)} x 
                    <input type="number" min="1" value="${item.quantidade}" data-id="${item.id}" class="qtd-input"> 
                    = R$ ${itemTotal.toFixed(2)}</p>
                </div>
                <button class="remover-btn" data-id="${item.id}" title="Remover item">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            carrinhoContainer.appendChild(div);

            const summaryDiv = document.createElement("div");
            summaryDiv.classList.add("summary-item");
            summaryDiv.innerHTML = `
                <div class="summary-label">${item.nome} (${item.quantidade}x)</div>
                <div class="summary-value">R$ ${itemTotal.toFixed(2)}</div>
            `;
            sidebarProducts.appendChild(summaryDiv);
        });

        sidebarTotal.textContent = `R$ ${total.toFixed(2)}`;

        document.querySelectorAll(".remover-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                const novoCarrinho = carrinho.filter(p => p.id !== id);
                localStorage.setItem("carrinho", JSON.stringify(novoCarrinho));
                atualizarCarrinho();
            });
        });

        document.querySelectorAll(".qtd-input").forEach(input => {
            input.addEventListener("change", () => {
                const id = input.dataset.id;
                const produto = carrinho.find(p => p.id === id);
                if (produto) {
                    produto.quantidade = Math.max(1, parseInt(input.value) || 1);
                    localStorage.setItem("carrinho", JSON.stringify(carrinho));
                    atualizarCarrinho();
                }
            });
            
            input.addEventListener("blur", () => {
                if (!input.value || parseInt(input.value) < 1) {
                    input.value = 1;
                    const id = input.dataset.id;
                    const produto = carrinho.find(p => p.id === id);
                    if (produto) {
                        produto.quantidade = 1;
                        localStorage.setItem("carrinho", JSON.stringify(carrinho));
                        atualizarCarrinho();
                    }
                }
            });
        });
    }

    function updateFinalSummary() {
        const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
        const total = calcularTotalCarrinho();
        const email = document.getElementById('email').value;
        
        const summaryProduct = document.getElementById('summary-product');
        if (summaryProduct) {
            if (carrinho.length === 1) {
                summaryProduct.textContent = carrinho[0].nome;
            } else {
                summaryProduct.textContent = `${carrinho.length} produtos`;
            }
        }
        
        const summaryPayment = document.getElementById('summary-payment');
        if (summaryPayment) {
            summaryPayment.textContent = 'Google Pay';
        }
        
        const summaryEmail = document.getElementById('summary-email');
        if (summaryEmail) {
            summaryEmail.textContent = email;
        }
        
        const summaryTotal = document.getElementById('summary-total');
        if (summaryTotal) {
            summaryTotal.textContent = `R$ ${total.toFixed(2)}`;
        }
    }

    function calcularTotalCarrinho() {
        const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
        return carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
    }

    // ==================== INICIALIZAﾃﾃグ ====================
    document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        try {
            const res = await fetch("/api/usuario");
            if (!res.ok) throw new Error("Usuﾃ｡rio nﾃ｣o logado");
            const usuario = await res.json();

            document.getElementById("user-nome-step2").textContent = usuario.nome + " " + usuario.sobrenome;
            document.getElementById("email").value = usuario.email;
        } 
        catch (error) {
            console.error("Erro ao carregar dados do usuﾃ｡rio:", error);
            window.location.href = "/login";
        }
        
        atualizarCarrinho();
        initializeGooglePay();
    });
  </script>
  <script src="https://pay.google.com/gp/p/js/pay.js"></script>
  <script src="/js/google-pay.js"></script>
</body>
</html>